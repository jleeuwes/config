function RmlToolBar(t,e,i,n,o){this.reactionFormContent=t,this.reactionFormToolbar=null,this.toolbarItemMap={},this.smiliePopup=null,this.controlActions={66:"bold",73:"italic",75:"link",83:"strike",85:"underline"},this.mentions=null,this.displayMode=this.validateDisplayMode(e),this.lang=this.validateLanguage(i),this.context=n,this.adminMode=o,this.setTranslations(),this.init()}function Mentions(t,e){this.itemType=t,this.itemId=e,this.active=!1,this.rmlToolbar=null,this.reactionFormContent=null,this.selectionStart=null,this.content=null,this.nomatch=null,this.itemSuggestions=null,this.suggestionBox=null,this.shadowBox=null,this.suggestionBoxItems=5,this.mentionMaxLength=15,this.selectedItem=0}Object.extend(RmlToolBar.prototype,{init:function(){if(this.reactionFormContent){for(var t,e=this.getToolbarItems(this.context),i=0;t=e[i++];)this.toolbarItemMap[t]=t;if(this.reactionFormToolbar=this.createToolbar(e)){var n=document.createElement("div");n.className="rmlToolbarWrapper "+this.displayMode,this.reactionFormContent.parentNode.insertBefore(n,this.reactionFormContent),n.appendChild(this.reactionFormToolbar),n.appendChild(this.reactionFormContent)}this.reactionFormContent.onkeydown=this.shortKey.bind(this)}},getToolbarItems:function(t){var e=["bold","italic","strike"];switch(t){case"forum":e.push("h1","h2","h3","left","center","right"),this.adminMode&&e.push("bg_color","text_color"),e.push("link","quote","split_quote","code","list_bullet","list_number","table","img","video");break;case"comments":e.unshift("smilies"),e.push("link","quote","list_bullet");break;case"va":case"userreview":e.unshift("h1","h2","h3","toc");case"weblogs":default:e.unshift("smilies"),e.push("link","list_bullet"),"userreview"===t&&e.push("img","video")}return e},validateDisplayMode:function(t){var e=["vertical","horizontal","none"];return e[Math.max(0,e.indexOf(t&&t.toLowerCase()))]},validateLanguage:function(t){var e=["nl","en"];return e[Math.max(0,e.indexOf(t&&t.toLowerCase()))]},setTranslations:function(){this.translations={nl:{maximize:"Vergroot tekstveld",minimize:"Verklein tekstveld",smilies:"Smilies",bold:"Tekst vet maken",italic:"Tekst schuin zetten",underline:"Tekst onderlijnen",strike:"Tekst doorstrepen",sub:"Tekst in subschrift zetten",sup:"Tekst in superschrift zetten",small:"Tekst verkleinen",list_bullet:"Ongesorteerde lijst maken",list_number:"Gesorteerde Lijst maken",link:"Link maken",left:"Tekst links uitlijnen",center:"Tekst centreren",right:"Tekst rechts uitlijnen",bg_color:"Achtergrondkleur kiezen",text_color:"Tekstkleur kiezen",img:"Afbeelding toevoegen",table:"Tabel toevoegen",video:"Video toevoegen",ruler:"Scheidingslijn toevoegen",split_quote:"Splits quote",h1:"Heading level 1 toevoegen",h2:"Heading level 2 toevoegen",h3:"Heading level 3 toevoegen",toc:"Automatische inhoudsopgave toevoegen",prompt_desc:"Voer omschrijving in:",prompt_url:"Voer de URL in:",prompt_hex:"Voer een hexadecimale kleurcode in:",code:"Pre-formatted tekst"},en:{maximize:"Maximize text area",minimize:"Minimize text area",smilies:"Smilies",bold:"Make text bold",italic:"Make text italic",underline:"Underline text",strike:"Strike through",sub:"Subscript",sup:"Superscript",small:"Make text small",list_bullet:"Create unsorted list",list_number:"Create sorted list",link:"Create link",left:"Align text left",right:"Center text",center_right:"Align text right",bg_color:"Select background color",text_color:"Select text color",img:"Insert image",table:"Insert table",video:"Insert video",ruler:"Insert horizontal ruler",split_quote:"Split quote",h1:"Insert heading level 1",h2:"Insert heading level 2",h3:"Insert heading level 3",toc:"Insert automatic table of contents",prompt_desc:"Enter description:",prompt_url:"Enter URL:",prompt_hex:"Enter a hexadecimal colorcode:",code:"Pre-formatted text"}}},isImgAllowed:function(){return"forum"===this.context||"userreview"===this.context},createToolbar:function(t){if("none"!==this.displayMode){for(var e,i,n=0,o=[];e=t[n++];)(i=document.createElement("span")).className=e,i.title=this.getTitle(e),addEvent(i,"click",this.rteToolbarAction.bind(this,e)),o.push(i);return HTMLBuilder().built({n:"div",a:{className:"rmlToolbar"},c:{n:"div",a:{className:"buttons"},c:o}})}},createSmiliePopup:function(){var t=Ajax.sendRequest(getXmlHttpUrl("frontpage","smilies"),{method:"GET",type:"json",async:!1,nocache:!1});if(t){var e,i=[];for(var n in t)t.hasOwnProperty(n)&&(e=t[n],i.push({n:"span",a:{title:n,onclick:this.rteInsert.bind(this," "+n+" ")},c:{n:"img",a:{src:jsConfig.get("ImgURL")+"g/s/"+e[0],style:"width:"+e[1]+"px;height:"+e[2]+"px;margin-left:"+Math.floor((32-e[1])/2)+"px;margin-top:"+Math.floor((22-e[2])/2)+"px;"}}}));var o=HTMLBuilder().built({n:"div",a:{id:"smilies"},c:i});return document.body.appendChild(o),o}return!1},showSmilies:function(){null===this.smiliePopup&&(this.smiliePopup=this.createSmiliePopup()),this.smiliePopup&&("block"==this.smiliePopup.style.display?this.smiliePopup.style.display="none":("horizontal"==this.displayMode?setRelativePosition(this.smiliePopup,this.reactionFormToolbar,34,0):setRelativePosition(this.smiliePopup,this.reactionFormToolbar,0,28),this.smiliePopup.style.display="block"))},rteToolbarAction:function(t){if("img"===t&&"forum"===this.context&&jsConfig.get("UserID")&&window.UserImageUploader)UserImageUploader.show(this);else switch(t){case"link":var e=this.getReactionFormSelection();/^(https?:\/\/|www\.)/i.test(e)?PromptInput.show(this,this.xlate("prompt_desc"),t):PromptInput.show(this,this.xlate("prompt_url"),"url");break;case"bg_color":case"text_color":PromptInput.show(this,this.xlate("prompt_hex"),t,"#");break;case"video":case"img":this.reactionFormHasSelection()?this.rteAction(t):PromptInput.show(this,this.xlate("prompt_url"),t);break;case"smilies":return void this.showSmilies();default:this.rteAction(t)}},rteInsert:function(t,e){this.reactionFormContent.focus();var i=this.reactionFormContent.selectionStart,n=this.reactionFormContent.selectionEnd,o=this.reactionFormContent.scrollTop;this.reactionFormContent.value=this.reactionFormContent.value.substr(0,i)+t+this.reactionFormContent.value.substr(n);var s=(t.match(/\r\n/g)||[]).length;this.reactionFormContent.setSelectionRange(i==n||e?i+t.length:i,i+t.length-s),this.reactionFormContent.scrollTop=o},rteAction:function(t,e){this.rteInsert(this.rteReplace(t,this.getReactionFormSelection(),e))},rteReplace:function(t,e,i){switch(i=i||"",t){case"bold":e="[b]"+e+"[/b]";break;case"italic":e="[i]"+e+"[/i]";break;case"underline":e="[u]"+e+"[/u]";break;case"strike":e="[s]"+e+"[/s]";break;case"sub":case"sup":case"small":case"left":case"center":case"right":case"h1":case"h2":case"h3":case"code":e="["+t+"]"+e+"[/"+t+"]";break;case"list_bullet":e="[list]\r\n[li]"+e.split(/\r?\n/).join("[/li]\r\n[li]")+"[/li]\r\n[/list]";break;case"list_number":e="[list=1]\r\n[li]"+e.split(/\r?\n/).join("[/li]\r\n[li]")+"[/li]\r\n[/list]";break;case"bg_color":e="[bgcolor="+i+"]"+e+"[/bgcolor]";break;case"text_color":e="[color="+i+"]"+e+"[/color]";break;case"img":case"video":""!==i&&(e=i),e="["+t+"]"+e+"[/"+t+"]";break;case"table":e="[table border=1 width=350 cellpadding=2 bordercolor=#000000]\r\n[tr]\r\n[td]"+e.split(/\r?\n/).join("[/td]\r\n[/tr]\r\n[tr]\r\n[td]")+"[/td]\r\n[/tr]\r\n[/table]";break;case"ruler":e+="[hr]";break;case"split_quote":e+="[/quote]\r\n[quote]";break;case"toc":e+="[toc]";break;case"link":e=this.getUbbLink(e,i);break;case"url":e=this.getUbbLink(i,e);break;case"quote":e="[quote]\r\n"+e+"\r\n[/quote]"}return e},getUbbLink:function(t,e){return e?'[url="'+t.replace(/(["\\])/g,"\\$1")+'"]'+e+"[/url]":"[url]"+t+"[/url]"},getControlKeyCodeByAction:function(t){for(var e in this.controlActions)if(this.controlActions[e]===t)return e;return null},shortKey:function(t){if(this.mentions&&this.mentions.active&&this.mentions.keyHandler(t))return cancelEvent(t);var e=t.keyCode||t.which-32;return!(e in this.controlActions&&(t.metaKey||t.ctrlKey)&&!t.shiftKey&&!t.altKey)||(this.toolbarItemMap[this.controlActions[e]]&&this.rteToolbarAction(this.controlActions[e]),cancelEvent(t))},getTitle:function(t){var e=this.xlate(t),i=this.getControlKeyCodeByAction(t);return i?e+" (CTRL+"+String.fromCharCode(i>=96&&i<=105?i-48:i)+")":e},xlate:function(t){return t in this.translations[this.lang]?this.translations[this.lang][t]:t},setMentionHandler:function(t){this.mentions=t,t.init(this,this.reactionFormContent)},linkIsAnImage:function(t){var e=t.toLowerCase();return!!/\.(jpe?g|png|gif|webp)(\?|$)/.test(e)||!(!e.includes("?")||!e.startsWith("https://pbs.twimg.com/media/"))&&/format=(jpg|png|gif)/.test(e)},reactionFormHasSelection:function(){return this.reactionFormContent.selectionStart!==this.reactionFormContent.selectionEnd},getReactionFormSelection:function(){if(!this.reactionFormHasSelection())return"";var t=this.reactionFormContent.value.substring(this.reactionFormContent.selectionStart,this.reactionFormContent.selectionEnd);return t=t.replace(/^\s+/g,""),this.reactionFormContent.selectionStart=this.reactionFormContent.selectionEnd-t.length,t=t.replace(/\s+$/g,""),this.reactionFormContent.selectionEnd=this.reactionFormContent.selectionStart+t.length,t}}),Object.extend(Mentions.prototype,{init:function(t,e){this.rmlToolbar=t,this.reactionFormContent=e,this.reactionFormContent.oninput=this.keyPress.bind(this),this.reactionFormContent.onblur=this.closeDelayed.bind(this)},keyPress:function(){if(!this.active){var t=this.reactionFormContent.selectionStart,e=this.reactionFormContent.value.substring(Math.max(0,t-(this.mentionMaxLength+2)),t),i=e.lastIndexOf("@");if(i<0)return;for(;i>0&&"@"===e.charAt(i-1);)i--;if(0===i&&e.length>this.mentionMaxLength+1)return;if(i>0&&/[\w!%&*$]/.test(e.charAt(i-1)))return;this.selectionStart=t-e.length+i,this.active=!0}this.update()},update:function(){var t=this.reactionFormContent.selectionEnd;if(t<=this.selectionStart)return this.close();var e=this.content;this.checkContent(t)&&this.content!==e&&this.showSuggest()},close:function(){if(this.active)return this.content=null,this.nomatch=null,this.suggestionBox&&(this.suggestionBox.style.display="none"),this.active=!1},closeDelayed:function(){this.active&&setTimeout(this.close.bind(this),200)},checkContent:function(t){var e=this.reactionFormContent.value.substring(this.selectionStart,t);return e.startsWith("@")&&e.length<=this.mentionMaxLength+1&&!/[\r\n]/.test(e)?(this.content=e.substr(1),!0):this.close()},showSuggest:function(){""===this.content?this.showItemSuggestions():this.showUserSuggestions(this.content)},showItemSuggestions:function(){if(null!==this.itemSuggestions)""===this.content&&this.showSuggestionBox(this.itemSuggestions.slice(0,this.suggestionBoxItems));else if(this.itemSuggestions=[],this.itemType&&this.itemId){var t=getXmlHttpUrl("frontpage","suggest","topposters");Ajax.sendRequest(t+"&itemType="+this.itemType+"&itemId="+this.itemId,{type:"json",async:!0,handler:this.addItemSuggestions.bind(this)})}},addItemSuggestions:function(t){Array.isArray(t)&&(this.itemSuggestions=t),this.showItemSuggestions()},showUserSuggestions:function(t){if(this.nomatch&&t.startsWith(this.nomatch))return this.suggestionBox.innerHTML="",void(this.suggestionBox.style.display="none");var e=getXmlHttpUrl("frontpage","suggest","username");Ajax.sendRequest(e+"&limit="+this.suggestionBoxItems+"&char="+encodeURIComponent(t),{type:"json",async:!0,handler:this.addUserSuggestions.bind(this,t)})},addUserSuggestions:function(t,e){if(t===this.content){if(this.itemSuggestions&&this.itemSuggestions.length){var i,n=[],o=0,s={};for(t=t.toLowerCase();i=this.itemSuggestions[o++];)i.Nickname.toLowerCase().startsWith(t)&&(n.push(i),s[i.UserID]=1);for(o=0;i=e[o++];)i.UserID in s||n.push(i);e=n.slice(0,this.suggestionBoxItems)}this.showSuggestionBox(e)}},showSuggestionBox:function(t){if(this.active){if(this.suggestionBox?this.suggestionBox.innerHTML="":(this.suggestionBox=document.createElement("div"),this.suggestionBox.className="mentionDiv dropdown",this.reactionFormContent.parentNode.insertBefore(this.suggestionBox,this.reactionFormContent)),0===t.length)return this.nomatch=this.content,void(this.suggestionBox.style.display="none");for(var e,i,n=0,o=document.createElement("ul");e=t[n++];)i=HTMLBuilder().built({n:"li",a:{className:(1===n?"active":"")+(e.topicStarter?" topicStarter":""),onclick:this.generateMentionTag.bind(this,e.Nickname)},c:[{n:"span",a:{className:"thumb usericonsmall"+(e.IconUrl?"":" empty")},c:e.IconUrl?{n:"img",a:{src:e.IconUrl,alt:"",width:20,height:20}}:null},{t:e.Nickname}]}),o.appendChild(i);this.suggestionBox.appendChild(o),this.setActive(0),this.suggestionBox.style.display="";var s=this.getPhysicalCaretPos(),r=getOffsetTop(this.reactionFormContent,this.reactionFormContent.offsetParent)+s[0],a=Math.min(getOffsetLeft(this.reactionFormContent,this.reactionFormContent.offsetParent)+s[1],this.reactionFormContent.offsetParent.offsetWidth-this.suggestionBox.offsetWidth);this.suggestionBox.style.top=r+3+"px",this.suggestionBox.style.left=a+"px"}},generateMentionTag:function(t){t.match(/[\[\]]/)&&(t='"'+t+'"'),this.reactionFormContent.selectionStart=this.selectionStart,this.reactionFormContent.selectionEnd=this.selectionStart+this.content.length+1,this.rmlToolbar.rteInsert("[~"+t+"] ",!0),this.close()},keyHandler:function(t){var e,i=!1;switch(t.keyCode){case keyCodes.ESC:this.close(),i=!0;break;case keyCodes.TAB:case keyCodes.ENTER:(e=this.getListItem(this.selectedItem))&&(e.onclick(),i=!0);break;case keyCodes.UP:this.setActive(this.selectedItem-1),i=!0;break;case keyCodes.DOWN:this.setActive(this.selectedItem+1),i=!0}return i},getListItem:function(t){return this.suggestionBox.firstChild&&this.suggestionBox.firstChild.childNodes[t]},setActive:function(t){var e=this.getListItem(t),i=this.getListItem(this.selectedItem);e&&(i&&removeClass(i,"active"),addClass(e,"active"),this.selectedItem=t)},getPhysicalCaretPos:function(){this.shadowBox||(this.shadowBox=this.createShadowBox(),this.reactionFormContent.parentNode.insertBefore(this.shadowBox,this.reactionFormContent)),this.shadowBox.innerHTML="",this.shadowBox.appendChild(document.createTextNode(this.reactionFormContent.value.substring(0,this.selectionStart+1)));var t=document.createElement("span");t.appendChild(document.createTextNode(this.content)),this.shadowBox.appendChild(t);var e=this.shadowBox.getBoundingClientRect(),i=t.getBoundingClientRect();return[i.bottom-e.top-this.reactionFormContent.scrollTop,i.left-e.left]},createShadowBox:function(){for(var t,e,i=["padding-top","padding-left","padding-right","padding-bottom","border-top-width","border-left-width","border-right-width","border-bottom-width","font-size","line-height"],n="position:absolute;visibility:hidden;white-space:pre-wrap;word-wrap:break-word;box-sizing:border-box;",o=0;t=i[o++];)(e=computedStyle(this.reactionFormContent,t))&&(n+=t+":"+e+";");n+="width:"+this.reactionFormContent.offsetWidth+"px;";var s=document.createElement("div");return s.style.cssText=n,s}});var PromptInput=function(){var t,e,i,n=function(t,n){var o={n:"form",a:{onsubmit:r,method:"post",action:"#",id:"promptInputModal"},c:[{n:"h3",t:t},{n:"input",a:{type:"text",className:"text",id:"promptInputValue",placeholder:n}}]};return"url"===i&&(o.c[1].a.type="url",o.c[1].a.onkeyup=s,e.isImgAllowed()&&o.c.push({n:"p",c:[{n:"input",a:{type:"checkbox",id:"promptInputIsImage"}},{n:"label",a:{for:"promptInputIsImage"},t:"Weergeven als afbeelding"}]})),o.c.push({n:"input",a:{type:"submit",value:"Invoegen",className:"ctaButton submit"}},{n:"input",a:{type:"button",value:"Annuleren",className:"ctaButton link",onclick:l}}),o},o=function(e,i){ModalDialog.show(function(e,i){return t=HTMLBuilder().built(n(e,i))}(e,i),null,c)},s=function(){var i=t.elements.promptInputIsImage,n=t.elements.promptInputValue;i&&!i.checked&&e.linkIsAnImage(n.value)&&(i.checked=!0)},r=function(){return ModalDialog.hide(),a(t.elements.promptInputValue.value),!1},a=function(n){n?"url"===i&&t.elements.promptInputIsImage&&t.elements.promptInputIsImage.checked?e.rteAction("img",n):e.rteAction(i,n):e.reactionFormContent.focus()},l=function(){ModalDialog.hide()},c=function(){e.reactionFormContent.focus()};return{show:function(n,s,r,a){e=n,i=r,o(s,a||""),t.elements.promptInputValue.focus()}}}();