#!/usr/bin/env bash

# We gaan ervanuit dat de gebruiker zichzelf als default recipient heeft gezet.

gpg=gpg2

if ! type -P $gpg > /dev/null; then
  echo "Ja, hallo, ik kan gpg niet vinden." 1>&2
fi

case "$1" in
  (mount)
    exit
  ;;
  (umount)
    exit
  ;;
  (ls)
    ls ~/passwords
  ;;
  (show|cat)
    shift
    for i in $@; do
      # esc=$(echo "$i" | sed '[^a-zA-Z0-9_-+=#      #blabla, TODO whitelisten
      esc=${i//@/\\@}
      esc=${esc//./\\.}
      file=~/passwords/"$i"
      if [ -f "$file" ]; then
        [ $# -gt 1 ] && echo -en "\e[32m$i:\e[m "
        $gpg --use-agent --batch -d "$file" 2>/dev/null
      else
        [ $# -gt 1 ] && echo -en "\e[31m$i:\e[m " 1>&2
        echo "niet gevonden"  1>&2
      fi
    done
  ;;
  (add|new)
    shift
    naam=$1
    [ -z "$naam" ] && exit 2

    file=~/passwords/"$naam"
    if [ -e "$file" ]; then
      echo "Wachtwoord voor $naam bestaat al."
      exit 1
    fi
    
    stty -echo
    pass=""
    read -r -p "Wachtwoord voor $naam: " pass
    stty echo
    echo
    [ -z "$pass" ] && exit 2
    echo "$pass" | $gpg --use-agent --armor --encrypt --sign > "$file" || exit 1
    echo "Wachtwoord voor $naam opgeslagen."
  ;;
  (rm)
    shift
    "$0" cat "$1" || exit 1
    rm ~/passwords/"$1"
    echo "Wachtwoord voor $1 verwijderd."
  ;;
  (complete)
    cmd=$2
    word=$3
    prev=$4
    if [ "$prev" = "$cmd" ]; then
      compgen -W "cat ls new rm" "$word"
    elif [ "$prev" = cat -o "$prev" = rm ]; then
      compgen -W "$($0 ls)" "$word"
    fi
  ;;
  (*)
    echo "Onbekend commando '$1'. Tot ziens!"
  ;;
esac

